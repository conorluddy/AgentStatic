{# components/molecules/form-group/form-group.njk #}

{#
  Form Group Component (Molecule)

  Complete form field combining label + input + validation messages + help text.
  Critical for accessible forms and reducing form friction by 50%+.

  Props:
    - label (string, required): Form field label text
    - inputId (string, required): Unique ID for input (for label association)
    - input (object, required): Input component props (passed to Input atom)
    - layout (string): Layout variant - 'vertical', 'horizontal' (default: 'vertical')
    - required (boolean): Shows required indicator (*) (default: false)
    - optional (boolean): Shows optional indicator (optional) (default: false)
    - helpText (string): Help text displayed below input
    - errorMessage (string): Error message (shows when state='error')
    - successMessage (string): Success message (shows when state='success')
    - warningMessage (string): Warning message (shows when state='warning')
    - state (string): Validation state - 'default', 'error', 'success', 'warning' (default: 'default')
    - showCharacterCount (boolean): Show character count for textarea (default: false)
    - maxLength (number): Maximum character length (used with showCharacterCount)
    - className (string): Additional CSS classes
    - attributes (object): Additional HTML attributes

  Usage:
    {% from "molecules/form-group/form-group.njk" import formGroup %}
    {{ formGroup({
      label: 'Email Address',
      inputId: 'email',
      input: {
        type: 'email',
        placeholder: 'your@email.com',
        required: true
      },
      required: true,
      helpText: "We'll never share your email"
    }) }}

  Horizontal Layout:
    {{ formGroup({
      label: 'Full Name',
      inputId: 'name',
      input: { type: 'text' },
      layout: 'horizontal'
    }) }}

  Error State:
    {{ formGroup({
      label: 'Email Address',
      inputId: 'email',
      input: { type: 'email', state: 'error' },
      state: 'error',
      errorMessage: 'Please enter a valid email address'
    }) }}
#}

{% from "atoms/input/input.njk" import input %}

{% macro formGroup(props = {}) %}
  {% set defaults = {
    layout: 'vertical',
    required: false,
    optional: false,
    state: 'default',
    showCharacterCount: false,
    className: '',
    attributes: {}
  } %}

  {% set config = defaults | merge(props) %}

  {# Generate IDs for aria-describedby #}
  {% set helpId = config.inputId + '-help' %}
  {% set errorId = config.inputId + '-error' %}
  {% set successId = config.inputId + '-success' %}
  {% set warningId = config.inputId + '-warning' %}
  {% set countId = config.inputId + '-count' %}

  {# Build aria-describedby string #}
  {% set describedByParts = [] %}
  {% if config.helpText %}
    {% set describedByParts = (describedByParts.push(helpId), describedByParts) %}
  {% endif %}
  {% if config.errorMessage and config.state == 'error' %}
    {% set describedByParts = (describedByParts.push(errorId), describedByParts) %}
  {% endif %}
  {% if config.successMessage and config.state == 'success' %}
    {% set describedByParts = (describedByParts.push(successId), describedByParts) %}
  {% endif %}
  {% if config.warningMessage and config.state == 'warning' %}
    {% set describedByParts = (describedByParts.push(warningId), describedByParts) %}
  {% endif %}
  {% if config.showCharacterCount %}
    {% set describedByParts = (describedByParts.push(countId), describedByParts) %}
  {% endif %}
  {% set describedBy = describedByParts | join(' ') | trim %}

  {# Build class list #}
  {% set classList = [
    'form-group',
    'form-group-' + config.layout if config.layout != 'vertical',
    'form-group--' + config.state if config.state != 'default',
    config.className
  ] | join(' ') | trim %}

  {# Main container #}
  <div
    class="{{ classList }}"
    {% for key, value in config.attributes %}
      {{ key }}="{{ value }}"
    {% endfor %}
  >
    {# Label #}
    <label for="{{ config.inputId }}" class="form-group-label">
      {{ config.label }}
      {% if config.required %}
        <span class="form-group-required" aria-label="required">*</span>
      {% endif %}
      {% if config.optional %}
        <span class="form-group-optional">(optional)</span>
      {% endif %}
    </label>

    {# For horizontal layout, wrap input + messages in field container #}
    {% if config.layout == 'horizontal' %}
      <div class="form-group-field">
    {% endif %}

    {# Input component #}
    {{ input(config.input | merge({
      id: config.inputId,
      state: config.state,
      ariaDescribedBy: describedBy if describedBy
    })) }}

    {# Help text #}
    {% if config.helpText %}
      <p class="form-group-help" id="{{ helpId }}">
        {{ config.helpText }}
      </p>
    {% endif %}

    {# Error message #}
    {% if config.errorMessage %}
      <p
        class="form-group-error"
        id="{{ errorId }}"
        role="alert"
        {% if config.state != 'error' %}hidden{% endif %}
      >
        {{ config.errorMessage }}
      </p>
    {% endif %}

    {# Success message #}
    {% if config.successMessage %}
      <p
        class="form-group-success"
        id="{{ successId }}"
        {% if config.state != 'success' %}hidden{% endif %}
      >
        {{ config.successMessage }}
      </p>
    {% endif %}

    {# Warning message #}
    {% if config.warningMessage %}
      <p
        class="form-group-warning"
        id="{{ warningId }}"
        {% if config.state != 'warning' %}hidden{% endif %}
      >
        {{ config.warningMessage }}
      </p>
    {% endif %}

    {# Character count #}
    {% if config.showCharacterCount and config.maxLength %}
      <p class="form-group-count" id="{{ countId }}">
        <span class="form-group-count-current">0</span> / {{ config.maxLength }}
      </p>
    {% endif %}

    {# Close horizontal field wrapper #}
    {% if config.layout == 'horizontal' %}
      </div>
    {% endif %}
  </div>
{% endmacro %}
