<!-- components/molecules/testimonial/testimonial.njk -->

{#
  Testimonial Molecule Component

  Description: Customer testimonial with quote, attribution, optional ratings, and company logos.
  Critical trust signal component for conversion optimization. Testimonials are top 3 trust signals.

  Props:
    - quote (string, required): The testimonial text/quote
    - author (object, required): Author information
      - name (string, required): Customer name
      - title (string): Job title
      - company (string): Company name
      - avatar (string): Avatar image URL
    - rating (number): Star rating (1-5)
    - logo (object): Company logo
      - src (string): Logo image URL
      - alt (string): Logo alt text
    - verified (boolean): Show verification badge (default: false)
    - verifiedText (string): Verification text (default: 'Verified Customer')
    - variant (string): Visual style - 'default', 'card', 'minimal', 'featured', 'inline' (default: 'default')
    - expandable (boolean): Enable quote expansion (default: false)
    - videoThumbnail (string): Video thumbnail URL for video testimonials
    - id (string): Unique identifier
    - className (string): Additional CSS classes
    - attributes (object): Additional HTML attributes
    - a11y (object): Accessibility properties

  Usage:
    {% from "molecules/testimonial/testimonial.njk" import testimonial %}

    <!-- Basic testimonial -->
    {{ testimonial({
      quote: 'This product changed our business completely!',
      author: {
        name: 'Sarah Johnson',
        title: 'CEO',
        company: 'Acme Corp'
      }
    }) }}

    <!-- With rating and verification -->
    {{ testimonial({
      quote: 'We saw a 127% increase in revenue within 3 months.',
      rating: 5,
      verified: true,
      author: {
        name: 'John Smith',
        title: 'VP of Marketing',
        company: 'TechStart Inc',
        avatar: '/images/john.jpg'
      },
      logo: {
        src: '/images/techstart-logo.svg',
        alt: 'TechStart Inc'
      },
      variant: 'card'
    }) }}

    <!-- Featured testimonial -->
    {{ testimonial({
      quote: 'The best investment we made this year. Saved us 10 hours per week.',
      rating: 5,
      verified: true,
      author: {
        name: 'Emily Chen',
        title: 'Director of Operations',
        company: 'Global Solutions'
      },
      variant: 'featured'
    }) }}

    <!-- Video testimonial -->
    {{ testimonial({
      quote: 'See why our team loves this product',
      videoThumbnail: '/videos/testimonial-thumb.jpg',
      author: {
        name: 'Mike Williams',
        company: 'Innovation Labs'
      },
      variant: 'card'
    }) }}
#}

{% from "atoms/text/text.njk" import text %}
{% from "atoms/icon/icon.njk" import icon %}

{% macro testimonial(props = {}) %}
  {% set defaults = {
    quote: '',
    author: {},
    rating: 0,
    logo: null,
    verified: false,
    verifiedText: 'Verified Customer',
    variant: 'default',
    expandable: false,
    videoThumbnail: '',
    className: '',
    attributes: {},
    a11y: {}
  } %}

  {% set config = defaults | merge(props) %}

  <!-- Validate required props -->
  {% if not config.quote %}
    {% set config.quote = 'Customer testimonial quote...' %}
  {% endif %}
  {% if not config.author.name %}
    {% set config.author = config.author | merge({ name: 'Anonymous' }) %}
  {% endif %}

  <!-- Build class list -->
  {% set classList = [
    'testimonial',
    'testimonial-' + config.variant,
    config.className
  ] | reject('equalto', '') | join(' ') | trim %}

  <!-- Main container - use blockquote for semantic HTML -->
  <blockquote
    class="{{ classList }}"
    {% if config.id %}id="{{ config.id }}"{% endif %}
    {% if config.a11y.role %}role="{{ config.a11y.role }}"{% endif %}
    {% if config.a11y.ariaLabel %}aria-label="{{ config.a11y.ariaLabel }}"{% endif %}
    {% if config.a11y.ariaDescribedBy %}aria-describedby="{{ config.a11y.ariaDescribedBy }}"{% endif %}
    {% for key, value in config.attributes %}
      {{ key }}="{{ value }}"
    {% endfor %}
  >
    <!-- Video Thumbnail (if provided) -->
    {% if config.videoThumbnail %}
      <div class="testimonial-video" tabindex="0" role="button" aria-label="Play video testimonial">
        <img
          src="{{ config.videoThumbnail }}"
          alt="Video testimonial from {{ config.author.name }}"
          class="testimonial-video-thumbnail"
        >
        <div class="testimonial-video-play" aria-hidden="true"></div>
      </div>
    {% endif %}

    <!-- Star Rating (if provided) -->
    {% if config.rating and config.rating > 0 %}
      <div class="testimonial-rating" role="img" aria-label="{{ config.rating }} out of 5 stars">
        <span class="testimonial-rating-text">{{ config.rating }} out of 5 stars</span>
        {% for i in range(1, 6) %}
          <svg
            class="testimonial-star{% if i <= config.rating %} testimonial-star--filled{% endif %}"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
          >
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Quote Text -->
    <p class="testimonial-quote{% if config.expandable %} testimonial-quote--expandable{% endif %}">
      {{ config.quote | safe }}
    </p>

    <!-- Expand button (if expandable) -->
    {% if config.expandable %}
      <button class="testimonial-expand-btn" type="button" aria-expanded="false">
        Read more
      </button>
    {% endif %}

    <!-- Footer: Avatar, Author, Logo -->
    <footer class="testimonial-footer">
      <!-- Avatar Image -->
      {% if config.author.avatar %}
        <img
          src="{{ config.author.avatar }}"
          alt="{{ config.author.name }}"
          class="testimonial-avatar"
        >
      {% endif %}

      <!-- Author Information -->
      <div class="testimonial-author">
        <cite class="testimonial-name">{{ config.author.name }}</cite>

        <!-- Title and Company -->
        {% if config.author.title or config.author.company %}
          <div class="testimonial-title">
            {% if config.author.title %}{{ config.author.title }}{% endif %}{% if config.author.title and config.author.company %} at {% endif %}{% if config.author.company %}{{ config.author.company }}{% endif %}
          </div>
        {% endif %}

        <!-- Verification Badge -->
        {% if config.verified %}
          <div class="testimonial-verified">
            <svg class="testimonial-verified-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            {{ config.verifiedText }}
          </div>
        {% endif %}
      </div>

      <!-- Company Logo -->
      {% if config.logo and config.logo.src %}
        <img
          src="{{ config.logo.src }}"
          alt="{{ config.logo.alt or config.author.company or 'Company logo' }}"
          class="testimonial-logo"
        >
      {% endif %}
    </footer>
  </blockquote>
{% endmacro %}
