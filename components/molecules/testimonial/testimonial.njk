<!-- components/molecules/testimonial/testimonial.njk -->

{#
  Testimonial Molecule Component
  Rebuilt incrementally to identify charAt error
#}

{% macro testimonial(props = {}) %}
  {% set defaults = {
    quote: 'Customer testimonial quote...',
    author: {
      name: 'Anonymous',
      title: '',
      company: '',
      avatar: ''
    },
    rating: 0,
    logo: null,
    verified: false,
    verifiedText: 'Verified Customer',
    variant: 'default',
    expandable: false,
    videoThumbnail: '',
    className: '',
    id: '',
    attributes: {},
    a11y: {}
  } %}

  {% set config = defaults | merge(props) %}

  <!-- Build class list -->
  {% set classList = 'testimonial testimonial-' + config.variant %}
  {% if config.className %}
    {% set classList = classList + ' ' + config.className %}
  {% endif %}

  <!-- Main container -->
  <blockquote
    class="{{ classList }}"
    {% if config.id %}id="{{ config.id }}"{% endif %}
    {% if config.a11y.role %}role="{{ config.a11y.role }}"{% endif %}
    {% if config.a11y.ariaLabel %}aria-label="{{ config.a11y.ariaLabel }}"{% endif %}
    {% if config.a11y.ariaDescribedBy %}aria-describedby="{{ config.a11y.ariaDescribedBy }}"{% endif %}
    {% for key, value in config.attributes %}
      {{ key }}="{{ value }}"
    {% endfor %}
  >
    <!-- Video Thumbnail -->
    {% if config.videoThumbnail %}
      <div class="testimonial-video" tabindex="0" role="button" aria-label="Play video testimonial">
        <img
          src="{{ config.videoThumbnail }}"
          alt="Video testimonial from {{ config.author.name }}"
          class="testimonial-video-thumbnail"
        >
        <div class="testimonial-video-play" aria-hidden="true"></div>
      </div>
    {% endif %}

    <!-- Star Rating -->
    {% if config.rating and config.rating > 0 %}
      <div class="testimonial-rating" role="img" aria-label="{{ config.rating }} out of 5 stars">
        <span class="testimonial-rating-text">{{ config.rating }} out of 5 stars</span>
        {% for i in range(1, 6) %}
          <svg
            class="testimonial-star{% if i <= config.rating %} testimonial-star--filled{% endif %}"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
          >
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Quote Text -->
    <p class="testimonial-quote{% if config.expandable %} testimonial-quote--expandable{% endif %}">
      {{ config.quote | safe }}
    </p>

    <!-- Expand button -->
    {% if config.expandable %}
      <button class="testimonial-expand-btn" type="button" aria-expanded="false">
        Read more
      </button>
    {% endif %}

    <!-- Footer: Avatar, Author, Logo -->
    <footer class="testimonial-footer">
      <!-- Avatar Image -->
      {% if config.author.avatar %}
        <img
          src="{{ config.author.avatar }}"
          alt="{{ config.author.name }}"
          class="testimonial-avatar"
        >
      {% endif %}

      <!-- Author Information -->
      <div class="testimonial-author">
        <cite class="testimonial-name">{{ config.author.name }}</cite>

        <!-- Title and Company -->
        {% if config.author.title or config.author.company %}
          <div class="testimonial-title">
            {% if config.author.title %}{{ config.author.title }}{% endif %}{% if config.author.title and config.author.company %} at {% endif %}{% if config.author.company %}{{ config.author.company }}{% endif %}
          </div>
        {% endif %}

        <!-- Verification Badge -->
        {% if config.verified %}
          <div class="testimonial-verified">
            <svg class="testimonial-verified-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            {{ config.verifiedText }}
          </div>
        {% endif %}
      </div>

      <!-- Company Logo -->
      {% if config.logo and config.logo.src %}
        <img
          src="{{ config.logo.src }}"
          alt="{{ config.logo.alt or config.author.company or 'Company logo' }}"
          class="testimonial-logo"
        >
      {% endif %}
    </footer>
  </blockquote>
{% endmacro %}
