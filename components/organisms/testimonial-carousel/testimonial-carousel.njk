<!-- components/organisms/testimonial-carousel/testimonial-carousel.njk -->

{#
  Testimonial Carousel Organism Component

  Description: Rotating carousel for displaying multiple customer testimonials. Social proof at scale
  that builds trust and drives conversions. Critical component for landing pages and product pages.

  Marketing Psychology:
    - Social proof at scale: Show 10+ testimonials in compact space
    - Video testimonials: 53% more trust than text alone (Wyzowl)
    - Variety signals credibility: Mix of industries/use cases shows broad appeal
    - Auto-play creates curiosity: Users watch 2-3 more testimonials with rotation
    - Strategic placement: After features, before pricing, before final CTA

  Props:
    - testimonials (array, required): Array of testimonial objects
      - Each testimonial object follows Testimonial molecule schema
    - variant (string): Layout style - 'single', 'grid', 'scroll', 'featured', 'minimal' (default: 'single')
    - autoplay (object): Auto-play configuration
      - enabled (boolean): Enable auto-play (default: false)
      - delay (number): Delay between slides in ms (default: 5000)
      - pauseOnHover (boolean): Pause on hover/focus (default: true)
    - showArrows (boolean): Show prev/next navigation arrows (default: true)
    - showDots (boolean): Show dot indicators (default: true)
    - heading (object): Optional section heading
      - text (string): Heading text
      - level (number): Heading level 1-6 (default: 2)
      - align (string): Text alignment - 'left', 'center', 'right' (default: 'center')
    - subheading (string): Optional subheading text
    - id (string): Unique identifier
    - className (string): Additional CSS classes
    - attributes (object): Additional HTML attributes
    - a11y (object): Accessibility properties

  Usage:
    {% from "organisms/testimonial-carousel/testimonial-carousel.njk" import testimonialCarousel %}

    <!-- Basic carousel -->
    {{ testimonialCarousel({
      testimonials: [
        {
          quote: 'This product changed our business completely!',
          rating: 5,
          author: { name: 'Sarah Johnson', title: 'CEO', company: 'Acme Corp' }
        },
        {
          quote: 'We saw a 127% increase in revenue within 3 months.',
          rating: 5,
          author: { name: 'John Smith', title: 'VP of Marketing', company: 'TechStart' }
        }
      ]
    }) }}

    <!-- Auto-play carousel with grid layout -->
    {{ testimonialCarousel({
      heading: { text: 'What Our Customers Say', align: 'center' },
      testimonials: testimonialsList,
      variant: 'grid',
      autoplay: { enabled: true, delay: 5000 }
    }) }}

    <!-- Featured testimonial carousel -->
    {{ testimonialCarousel({
      testimonials: testimonialsList,
      variant: 'featured',
      showArrows: true,
      showDots: true
    }) }}
#}

{% from "../molecules/testimonial/testimonial.njk" import testimonial %}

{% macro testimonialCarousel(props = {}) %}
  {% set defaults = {
    testimonials: [],
    variant: 'single',
    autoplay: {
      enabled: false,
      delay: 5000,
      pauseOnHover: true
    },
    showArrows: true,
    showDots: true,
    heading: null,
    subheading: '',
    className: '',
    attributes: {},
    a11y: {}
  } %}

  {% set config = defaults | merge(props) %}
  {% set autoplayConfig = defaults.autoplay | merge(config.autoplay) %}

  <!-- Validate required props -->
  {% if config.testimonials.length === 0 %}
    {% set config.testimonials = [
      {
        quote: 'This product changed our business completely. We saw immediate results.',
        rating: 5,
        author: { name: 'Sarah Johnson', title: 'CEO', company: 'Acme Corp' }
      },
      {
        quote: 'Outstanding service and incredible ROI. Highly recommended.',
        rating: 5,
        author: { name: 'John Smith', title: 'VP of Marketing', company: 'TechStart' }
      }
    ] %}
  {% endif %}

  <!-- Build class list -->
  {% set classList = [
    'testimonial-carousel',
    'testimonial-carousel-' + config.variant if config.variant !== 'single',
    config.className
  ] | reject('equalto', '') | join(' ') | trim %}

  <!-- Generate unique ID for carousel -->
  {% set carouselId = config.id or ('carousel-' + range(10000, 99999) | random | string) %}

  <!-- Main container -->
  <section
    class="{{ classList }}"
    id="{{ carouselId }}"
    role="region"
    aria-label="{{ config.a11y.ariaLabel or 'Customer testimonials' }}"
    {% if autoplayConfig.enabled %}data-autoplay="true"{% endif %}
    data-autoplay-delay="{{ autoplayConfig.delay }}"
    {% if autoplayConfig.pauseOnHover %}data-pause-on-hover="true"{% endif %}
    {% for key, value in config.attributes %}
      {{ key }}="{{ value }}"
    {% endfor %}
  >
    <div class="testimonial-carousel-container">
      <!-- Optional heading -->
      {% if config.heading %}
        <header style="text-align: {{ config.heading.align or 'center' }}; margin-bottom: var(--spacing-xl);">
          <h{{ config.heading.level or 2 }} style="margin: 0 0 var(--spacing-sm) 0; font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-text);">
            {{ config.heading.text }}
          </h{{ config.heading.level or 2 }}>
          {% if config.subheading %}
            <p style="margin: 0; font-size: var(--font-size-lg); color: var(--color-text-muted);">
              {{ config.subheading }}
            </p>
          {% endif %}
        </header>
      {% endif %}

      <!-- Carousel wrapper -->
      <div class="testimonial-carousel-wrapper">
        <!-- Carousel track -->
        <div
          class="testimonial-carousel-track"
          role="list"
          aria-live="polite"
          aria-atomic="false"
        >
          {% for item in config.testimonials %}
            <div
              class="testimonial-carousel-slide"
              role="listitem"
              {% if loop.index === 1 %}data-active="true"{% endif %}
              aria-label="Testimonial {{ loop.index }} of {{ config.testimonials.length }}"
            >
              {{ testimonial(item) }}
            </div>
          {% endfor %}
        </div>

        <!-- Navigation arrows -->
        {% if config.showArrows and config.testimonials.length > 1 %}
          <button
            class="testimonial-carousel-nav testimonial-carousel-nav-prev"
            type="button"
            aria-label="Previous testimonial"
            data-carousel-control="prev"
          >
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>

          <button
            class="testimonial-carousel-nav testimonial-carousel-nav-next"
            type="button"
            aria-label="Next testimonial"
            data-carousel-control="next"
          >
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        {% endif %}
      </div>

      <!-- Dot indicators -->
      {% if config.showDots and config.testimonials.length > 1 %}
        <div class="testimonial-carousel-indicators" role="tablist" aria-label="Testimonial navigation">
          {% for item in config.testimonials %}
            <button
              class="testimonial-carousel-dot"
              type="button"
              role="tab"
              {% if loop.index === 1 %}aria-current="true"{% else %}aria-current="false"{% endif %}
              aria-label="Go to testimonial {{ loop.index }}"
              data-carousel-index="{{ loop.index0 }}"
            ></button>
          {% endfor %}
        </div>
      {% endif %}

      <!-- Screen reader announcement region -->
      <div class="testimonial-carousel-sr-only" aria-live="polite" aria-atomic="true" data-carousel-announce></div>
    </div>
  </section>
{% endmacro %}
