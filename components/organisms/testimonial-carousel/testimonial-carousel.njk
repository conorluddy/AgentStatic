<!-- components/organisms/testimonial-carousel/testimonial-carousel.njk -->

{#
  Testimonial Carousel Organism

  Displays testimonials in a horizontal carousel with navigation.
  Rebuilt to avoid Nunjucks charAt parser errors.
#}

{% from "molecules/testimonial/testimonial.njk" import testimonial %}

{% macro testimonialCarousel(props = {}) %}
  {% set defaults = {
    testimonials: [],
    heading: '',
    subheading: '',
    variant: 'default',
    showArrows: true,
    showDots: true,
    autoplay: false,
    className: '',
    id: '',
    attributes: {},
    a11y: {}
  } %}

  {% set config = defaults | merge(props) %}

  <!-- Build class list (avoid complex filter chains) -->
  {% set classList = 'testimonial-carousel testimonial-carousel-' + config.variant %}
  {% if config.className %}
    {% set classList = classList + ' ' + config.className %}
  {% endif %}

  <!-- Main container -->
  <section
    class="{{ classList }}"
    {% if config.id %}id="{{ config.id }}"{% endif %}
    {% if config.a11y.role %}role="{{ config.a11y.role }}"{% endif %}
    {% if config.a11y.ariaLabel %}aria-label="{{ config.a11y.ariaLabel }}"{% else %}aria-label="Customer testimonials"{% endif %}
    {% for key, value in config.attributes %}
      {{ key }}="{{ value }}"
    {% endfor %}
  >
    <!-- Heading Section -->
    {% if config.heading %}
      <div class="testimonial-carousel-header">
        <h2 class="testimonial-carousel-heading">{{ config.heading }}</h2>
        {% if config.subheading %}
          <p class="testimonial-carousel-subheading">{{ config.subheading }}</p>
        {% endif %}
      </div>
    {% endif %}

    <!-- Carousel Container -->
    <div class="testimonial-carousel-container"
         data-autoplay="{{ 'true' if config.autoplay else 'false' }}">

      <!-- Testimonials Track -->
      <div class="testimonial-carousel-track" role="list">
        {% for item in config.testimonials %}
          <div class="testimonial-carousel-item" role="listitem">
            {{ testimonial(item) }}
          </div>
        {% endfor %}
      </div>

      <!-- Navigation Arrows -->
      {% if config.showArrows and config.testimonials|length > 1 %}
        <button
          class="testimonial-carousel-arrow testimonial-carousel-arrow-prev"
          aria-label="Previous testimonial"
          type="button"
        >
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <button
          class="testimonial-carousel-arrow testimonial-carousel-arrow-next"
          aria-label="Next testimonial"
          type="button"
        >
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      {% endif %}

      <!-- Pagination Dots -->
      {% if config.showDots and config.testimonials|length > 1 %}
        <div class="testimonial-carousel-dots" role="tablist" aria-label="Testimonial navigation">
          {% for item in config.testimonials %}
            <button
              class="testimonial-carousel-dot{% if loop.index0 == 0 %} testimonial-carousel-dot-active{% endif %}"
              role="tab"
              aria-label="Go to testimonial {{ loop.index }}"
              aria-selected="{% if loop.index0 == 0 %}true{% else %}false{% endif %}"
              data-index="{{ loop.index0 }}"
              type="button"
            ></button>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </section>
{% endmacro %}
