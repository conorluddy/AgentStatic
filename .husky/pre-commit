#!/usr/bin/env sh

# Exit on any error
set -e

echo "ğŸš€ AgentStatic Pre-commit Validation Starting..."

# Type Check: Ensure TypeScript compilation passes with zero any types
echo "âš¡ Running TypeScript type checking..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ Type checking failed! Please fix TypeScript errors before committing."
  echo "ğŸ’¡ Hint: Run 'npm run type-check' to see detailed errors."
  exit 1
fi
echo "âœ… TypeScript type checking passed!"

# Lint: ESLint must pass with zero warnings
echo "âš¡ Running ESLint..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ ESLint found errors or warnings! Code must pass with zero warnings."
  echo "ğŸ’¡ Hint: Run 'npm run lint:fix' to auto-fix some issues."
  exit 1
fi
echo "âœ… ESLint passed with zero warnings!"

# Format Check: Prettier must pass
echo "âš¡ Checking code formatting with Prettier..."
npm run format:check
if [ $? -ne 0 ]; then
  echo "âŒ Code formatting issues found!"
  echo "ğŸ’¡ Hint: Run 'npm run format' to auto-format your code."
  exit 1
fi
echo "âœ… Code formatting is correct!"

# Unit Tests: Must pass with <30s timeout
echo "âš¡ Running unit tests (30s timeout)..."

# Cross-platform timeout implementation
(npm run test) & TEST_PID=$!
SECONDS=0
while kill -0 $TEST_PID 2>/dev/null; do
  if [ $SECONDS -ge 30 ]; then
    echo "âŒ Tests timed out! Tests must complete within 30 seconds."
    echo "ğŸ’¡ Hint: Check for slow tests or infinite loops."
    kill -9 $TEST_PID 2>/dev/null
    exit 1
  fi
  sleep 1
  SECONDS=$((SECONDS + 1))
done
wait $TEST_PID
TEST_EXIT_CODE=$?

if [ $TEST_EXIT_CODE -ne 0 ]; then
  echo "âŒ Unit tests failed!"
  echo "ğŸ’¡ Hint: Run 'npm run test' to see detailed test results."
  exit 1
fi
echo "âœ… All unit tests passed!"

# Build Validation: Ensure the project builds successfully
echo "âš¡ Running build validation..."
npm run build
if [ $? -ne 0 ]; then
  echo "âŒ Build failed! The project must build successfully before committing."
  echo "ğŸ’¡ Hint: Check for compilation errors or missing dependencies."
  exit 1
fi
echo "âœ… Build completed successfully!"

# Coverage Check: Ensure >90% test coverage
echo "âš¡ Checking test coverage..."
npm run test:coverage > /tmp/coverage-output.txt 2>&1
COVERAGE_RESULT=$?
if [ $COVERAGE_RESULT -ne 0 ]; then
  echo "âŒ Coverage check failed!"
  cat /tmp/coverage-output.txt
  exit 1
fi

# Extract coverage percentage (looking for lines like "All files | 95.65 |")
COVERAGE=$(grep "All files" /tmp/coverage-output.txt | awk '{print $4}' | sed 's/%//')
if [ -n "$COVERAGE" ]; then
  COVERAGE_INT=$(echo "$COVERAGE" | cut -d. -f1)
  if [ "$COVERAGE_INT" -lt 90 ]; then
    echo "âŒ Test coverage is below 90% (current: ${COVERAGE}%)"
    echo "ğŸ’¡ Hint: Add more tests to increase coverage."
    cat /tmp/coverage-output.txt
    exit 1
  fi
  echo "âœ… Test coverage is ${COVERAGE}% (>90% required)!"
else
  echo "âš ï¸  Could not determine test coverage percentage, continuing..."
fi
rm -f /tmp/coverage-output.txt

# Lint-staged: Run on staged files only
echo "âš¡ Running lint-staged on changed files..."
npx lint-staged
if [ $? -ne 0 ]; then
  echo "âŒ Lint-staged checks failed on staged files!"
  exit 1
fi
echo "âœ… Lint-staged checks passed!"

echo "ğŸ‰ All pre-commit checks passed! Proceeding with commit..."
echo ""
echo "âš ï¸  REMINDER: If you need to bypass these checks in an emergency:"
echo "   Use: git commit --no-verify"
echo "   BUT you MUST fix any issues in the next commit!"
echo ""
